{% extends 'base.html.twig' %}

{% block title %}Chat with Assistant{% endblock %}

{% block body %}
<div class="container mt-5">
    <h1 class="mb-4">Chat with the Assistant</h1>

    <div id="chat-history" class="card mb-4" style="height: 400px; overflow-y: auto;">
        <div class="card-body">
            {% if question is defined and question is not null %}
            <div class="d-flex justify-content-end mb-3">
                <div class="message-bubble bg-primary text-white p-2 rounded-3 mw-75">
                    {{ question }}
                </div>
            </div>
            {% endif %}

            {% if response is defined and response is not null %}
            <div class="d-flex justify-content-start mb-3">
                <div class="message-bubble bg-light p-2 rounded-3 mw-75">
                    {{ response }}
                </div>
            </div>
            {% endif %}

            {{ form_start(form, {'attr': {'id': 'chat-form', 'class': 'mt-3'}, 'action': path('ask_assistant')}) }}
                <div class="input-group">
                    {{ form_widget(form.message, {'attr': {'class': 'form-control', 'placeholder': 'Tapez votre message...'}}) }}
                    <button type="submit" class="btn btn-primary">Envoyer</button>
                </div>
            {{ form_end(form) }}
        </div>
    </div>
</div>
{% endblock %}
{% block javascripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
    $(document).on('submit', '#chat-form', function(e) {
        e.preventDefault();

        $.ajax({
            type: 'POST',
            url: '/chat/send',
            data: $(this).serialize(),
            success: function(response) {
                // Afficher la question de l'utilisateur
                let questionHtml = '<div class="d-flex justify-content-end mb-3">' +
                    '<div class="message-bubble bg-primary text-white p-2 rounded-3 mw-75">' +
                    response.question + '</div></div>';
                $('#chat-history .card-body').append(questionHtml);

                // Afficher la réponse de GPT
                let responseHtml = '<div class="d-flex justify-content-start mb-3">' +
                    '<div class="message-bubble bg-light p-2 rounded-3 mw-75">' +
                    response.response + '</div></div>';  // Assure que c'est bien la réponse qui est affichée
                $('#chat-history .card-body').append(responseHtml);

                // Scroll vers le bas pour afficher le dernier message
                $('#chat-history').scrollTop($('#chat-history')[0].scrollHeight);

                // Réinitialiser le champ de texte
                $('#chat-form input[type="text"]').val('');
            }
        });
    });
});



</script>
{% endblock %}
